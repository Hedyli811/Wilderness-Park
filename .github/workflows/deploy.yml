name: Full Auto Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy Full Stack
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            echo "ğŸš€ å¼€å§‹å…¨æ ˆè‡ªåŠ¨éƒ¨ç½²..."

            # 1. æ‹‰å–æœ€æ–°ä»£ç 
            cd /opt/app/Wilderness-Park
            echo "æ‹‰å–æœ€æ–°ä»£ç ..."
            git pull origin main

            # 2. æ„å»ºåç«¯
            echo "æ„å»ºåç«¯..."
            cd mall4j
            mvn clean package -DskipTests

            # 3. é‡å¯åç«¯æœåŠ¡
            echo "é‡å¯åç«¯æœåŠ¡..."
            sudo systemctl restart wilderness-park-admin
            sudo systemctl restart wilderness-park-api

            # 4. æ„å»ºå‰ç«¯ï¼ˆåœ¨æœåŠ¡å™¨ä¸Šï¼‰
            echo "æ„å»ºå‰ç«¯..."
            cd ../mall4v

            # æ£€æŸ¥Node.jsç‰ˆæœ¬ï¼Œå¦‚æœå¤ªä½åˆ™å‡çº§
            if ! command -v node &> /dev/null || [ $(node -v | cut -d'v' -f2 | cut -d'.' -f1) -lt 16 ]; then
              echo "å®‰è£…Node.js 18..."
              curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi

            # å®‰è£…ä¾èµ–å¹¶æ„å»º
            npm ci
            npm run build

            # 5. éƒ¨ç½²å‰ç«¯
            echo "éƒ¨ç½²å‰ç«¯..."
            sudo rm -rf /var/www/admin/*
            sudo cp -r dist/* /var/www/admin/
            sudo chown -R nginx:nginx /var/www/admin

            # 6. é‡å¯Nginx
            echo "é‡å¯Nginx..."
            sudo systemctl reload nginx

            echo "âœ… å…¨æ ˆéƒ¨ç½²å®Œæˆï¼"
            echo "ğŸŒ è®¿é—®åœ°å€: http://${{ secrets.SERVER_HOST }}/admin/"
